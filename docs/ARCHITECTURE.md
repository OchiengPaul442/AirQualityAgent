# System Architecture - Air Quality AI Agent

## ğŸ—ï¸ High-Level Architecture

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                        CLIENT SIDE                               â”‚
â”‚  (Browser / Mobile App / Desktop)                                â”‚
â”‚                                                                   â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”       â”‚
â”‚  â”‚  Conversation Manager                                 â”‚       â”‚
â”‚  â”‚  â€¢ Maintains history array in memory                  â”‚       â”‚
â”‚  â”‚  â€¢ Sends history with each request                    â”‚       â”‚
â”‚  â”‚  â€¢ Handles token counting & cost tracking             â”‚       â”‚
â”‚  â”‚  â€¢ Local storage for persistence (optional)           â”‚       â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜       â”‚
â”‚                           â”‚                                       â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                            â”‚
                            â”‚ HTTPS (JSON)
                            â”‚ { message, history, save_to_db }
                            â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                     API GATEWAY LAYER                            â”‚
â”‚                   (FastAPI - routes.py)                          â”‚
â”‚                                                                   â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”          â”‚
â”‚  â”‚ Rate Limiter â”‚  â”‚ Auth Check   â”‚  â”‚ Input Valid. â”‚          â”‚
â”‚  â”‚ 20 req/60s   â”‚â†’ â”‚ (Optional)   â”‚â†’ â”‚ Pydantic     â”‚          â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜          â”‚
â”‚                                              â”‚                    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                               â”‚
                                               â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    SERVICE LAYER                                 â”‚
â”‚                  (agent_service.py)                              â”‚
â”‚                                                                   â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”        â”‚
â”‚  â”‚  1. Check Cache (MD5 hash of message + history)     â”‚        â”‚
â”‚  â”‚     â€¢ Educational queries: CACHE HIT â†’ Return        â”‚        â”‚
â”‚  â”‚     â€¢ City/real-time: BYPASS â†’ Continue              â”‚        â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜        â”‚
â”‚                           â”‚                                       â”‚
â”‚                           â–¼                                       â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”        â”‚
â”‚  â”‚  2. Build Context                                    â”‚        â”‚
â”‚  â”‚     â€¢ System instructions                            â”‚        â”‚
â”‚  â”‚     â€¢ Conversation history from client               â”‚        â”‚
â”‚  â”‚     â€¢ Available tools (WAQI, AirQo, Weather)         â”‚        â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜        â”‚
â”‚                           â”‚                                       â”‚
â”‚                           â–¼                                       â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”        â”‚
â”‚  â”‚  3. Call AI Provider                                 â”‚        â”‚
â”‚  â”‚     â€¢ Gemini / OpenAI / Ollama                       â”‚        â”‚
â”‚  â”‚     â€¢ Async streaming                                â”‚        â”‚
â”‚  â”‚     â€¢ Tool calling support                           â”‚        â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜        â”‚
â”‚                           â”‚                                       â”‚
â”‚                           â–¼                                       â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”        â”‚
â”‚  â”‚  4. Execute Tools (if needed)                        â”‚        â”‚
â”‚  â”‚     â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚        â”‚
â”‚  â”‚     â”‚ WAQI API   â”‚  â”‚ AirQo API  â”‚  â”‚ Weather    â”‚  â”‚        â”‚
â”‚  â”‚     â”‚ (80K sites)â”‚  â”‚ (588 sites)â”‚  â”‚ Open-Meteo â”‚  â”‚        â”‚
â”‚  â”‚     â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚        â”‚
â”‚  â”‚                                                       â”‚        â”‚
â”‚  â”‚     Each tool:                                        â”‚        â”‚
â”‚  â”‚     â€¢ Fetches data from external API                 â”‚        â”‚
â”‚  â”‚     â€¢ Caches response (1 hour)                       â”‚        â”‚
â”‚  â”‚     â€¢ Formats to 1 decimal place                     â”‚        â”‚
â”‚  â”‚     â€¢ Returns to AI for synthesis                    â”‚        â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜        â”‚
â”‚                           â”‚                                       â”‚
â”‚                           â–¼                                       â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”        â”‚
â”‚  â”‚  5. Format & Cache Response                          â”‚        â”‚
â”‚  â”‚     â€¢ Educational queries: Cache for 1 hour          â”‚        â”‚
â”‚  â”‚     â€¢ City-specific: No caching (real-time)          â”‚        â”‚
â”‚  â”‚     â€¢ Track tokens used                              â”‚        â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜        â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                            â”‚
                            â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    DATA LAYER                                    â”‚
â”‚                                                                   â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”          â”‚
â”‚  â”‚ Redis Cache  â”‚  â”‚ SQLite DB    â”‚  â”‚ External APIsâ”‚          â”‚
â”‚  â”‚              â”‚  â”‚              â”‚  â”‚              â”‚          â”‚
â”‚  â”‚ â€¢ Responses  â”‚  â”‚ â€¢ Saved      â”‚  â”‚ â€¢ WAQI       â”‚          â”‚
â”‚  â”‚ â€¢ API data   â”‚  â”‚   convos     â”‚  â”‚ â€¢ AirQo      â”‚          â”‚
â”‚  â”‚ â€¢ Rate limit â”‚  â”‚ â€¢ Sessions   â”‚  â”‚ â€¢ Weather    â”‚          â”‚
â”‚  â”‚   counters   â”‚  â”‚   (optional) â”‚  â”‚              â”‚          â”‚
â”‚  â”‚              â”‚  â”‚              â”‚  â”‚              â”‚          â”‚
â”‚  â”‚ TTL: 1 hour  â”‚  â”‚ Permanent    â”‚  â”‚ 3rd party    â”‚          â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜          â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## ğŸ”„ Request Flow (Detailed)

### **Scenario 1: Educational Query (Cacheable)**

```
User: "What is PM2.5?"
â”‚
â”œâ”€â–º API Gateway
â”‚   â”œâ”€â–º Rate Limit Check: âœ… PASS (5/20 requests)
â”‚   â””â”€â–º Input Validation: âœ… VALID
â”‚
â”œâ”€â–º Agent Service
â”‚   â”œâ”€â–º Cache Check
â”‚   â”‚   â”œâ”€â–º Generate MD5: hash("What is PM2.5?" + [])
â”‚   â”‚   â”œâ”€â–º Redis Lookup: âŒ MISS (first time)
â”‚   â”‚   â””â”€â–º Continue to AI
â”‚   â”‚
â”‚   â”œâ”€â–º AI Provider (Gemini)
â”‚   â”‚   â”œâ”€â–º System: "You are an air quality expert..."
â”‚   â”‚   â”œâ”€â–º User: "What is PM2.5?"
â”‚   â”‚   â”œâ”€â–º Tools: None needed
â”‚   â”‚   â””â”€â–º Response: "PM2.5 refers to particulate matter..."
â”‚   â”‚
â”‚   â””â”€â–º Cache Response
â”‚       â”œâ”€â–º Store in Redis (TTL: 3600s)
â”‚       â””â”€â–º Return to user
â”‚
â””â”€â–º Response
    â”œâ”€â–º "response": "PM2.5 refers to..."
    â”œâ”€â–º "tokens_used": 450
    â”œâ”€â–º "cached": false
    â””â”€â–º "tools_used": []

â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

User asks SAME question again:
â”‚
â”œâ”€â–º API Gateway: âœ…
â”‚
â”œâ”€â–º Agent Service
â”‚   â”œâ”€â–º Cache Check
â”‚   â”‚   â”œâ”€â–º Generate MD5: hash("What is PM2.5?" + [])
â”‚   â”‚   â”œâ”€â–º Redis Lookup: âœ… HIT!
â”‚   â”‚   â””â”€â–º Return cached response
â”‚   â”‚
â”‚   â””â”€â–º Skip AI call entirely
â”‚
â””â”€â–º Response
    â”œâ”€â–º "response": "PM2.5 refers to..." (same as before)
    â”œâ”€â–º "tokens_used": 0 (no AI call!)
    â”œâ”€â–º "cached": true âš¡
    â””â”€â–º "tools_used": []

ğŸ’° COST SAVINGS: 100% for this request
â±ï¸ SPEED: 3s â†’ 50ms (60x faster)
```

---

### **Scenario 2: City-Specific Query (Real-Time)**

```
User: "What's the air quality in Nairobi?"
â”‚
â”œâ”€â–º API Gateway: âœ…
â”‚
â”œâ”€â–º Agent Service
â”‚   â”œâ”€â–º Cache Check
â”‚   â”‚   â”œâ”€â–º Detect keywords: "nairobi", "current"
â”‚   â”‚   â””â”€â–º BYPASS cache (real-time data)
â”‚   â”‚
â”‚   â”œâ”€â–º AI Provider (Gemini)
â”‚   â”‚   â”œâ”€â–º Recognizes need for real-time data
â”‚   â”‚   â”œâ”€â–º Tool Call: get_city_feed(city="Nairobi")
â”‚   â”‚   â””â”€â–º Waits for tool result
â”‚   â”‚
â”‚   â”œâ”€â–º WAQI Service
â”‚   â”‚   â”œâ”€â–º Check Redis cache for API response
â”‚   â”‚   â”œâ”€â–º Cache MISS â†’ Call WAQI API
â”‚   â”‚   â”œâ”€â–º Receive: {"aqi": 45, "pm25": 12.7, ...}
â”‚   â”‚   â”œâ”€â–º Format to 1 decimal: {"aqi": 45.0, "pm25": 12.7}
â”‚   â”‚   â”œâ”€â–º Cache API response (TTL: 3600s)
â”‚   â”‚   â””â”€â–º Return to AI
â”‚   â”‚
â”‚   â”œâ”€â–º AI Synthesizes Response
â”‚   â”‚   â”œâ”€â–º "The current air quality in Nairobi is Good..."
â”‚   â”‚   â””â”€â–º Does NOT cache (city-specific)
â”‚   â”‚
â”‚   â””â”€â–º Return to user
â”‚
â””â”€â–º Response
    â”œâ”€â–º "response": "The current air quality in Nairobi..."
    â”œâ”€â–º "tokens_used": 520
    â”œâ”€â–º "cached": false
    â””â”€â–º "tools_used": ["waqi_api"]

ğŸ“ Real-time data, not cached
ğŸ”„ API data cached separately (1 hour)
```

---

### **Scenario 3: Contextual Follow-Up**

```
User: "What's the air in Nairobi?"
Response: "The air quality in Nairobi is Good (AQI 45)..."

â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

User: "What about tomorrow?"
â”‚
â”œâ”€â–º Client sends HISTORY:
â”‚   [
â”‚     {"role": "user", "content": "What's the air in Nairobi?"},
â”‚     {"role": "assistant", "content": "The air quality..."}
â”‚   ]
â”‚
â”œâ”€â–º API Gateway: âœ…
â”‚
â”œâ”€â–º Agent Service
â”‚   â”œâ”€â–º Cache Check: BYPASS (contains "tomorrow", "nairobi")
â”‚   â”‚
â”‚   â”œâ”€â–º AI Provider (Gemini)
â”‚   â”‚   â”œâ”€â–º System instructions
â”‚   â”‚   â”œâ”€â–º History (understands context!)
â”‚   â”‚   â”œâ”€â–º Current: "What about tomorrow?"
â”‚   â”‚   â””â”€â–º Tool Call: get_forecast(city="Nairobi")
â”‚   â”‚
â”‚   â”œâ”€â–º Weather Service
â”‚   â”‚   â”œâ”€â–º Geocode Nairobi â†’ lat/lon
â”‚   â”‚   â”œâ”€â–º Call Open-Meteo forecast API
â”‚   â”‚   â”œâ”€â–º Format data to 1 decimal
â”‚   â”‚   â””â”€â–º Return to AI
â”‚   â”‚
â”‚   â””â”€â–º AI Synthesizes
â”‚       â””â”€â–º "Tomorrow in Nairobi, the forecast shows..."
â”‚
â””â”€â–º Response
    â”œâ”€â–º "response": "Tomorrow in Nairobi..."
    â”œâ”€â–º "tokens_used": 480
    â”œâ”€â–º "cached": false
    â””â”€â–º "tools_used": ["weather_api"]

ğŸ§  Context-aware (knows we're talking about Nairobi)
ğŸ“… Forecast data provided
```

---

## ğŸ¯ Caching Strategy

### **What Gets Cached:**

```python
CACHEABLE_PATTERNS = [
    "what is",          # "What is PM2.5?"
    "what are",         # "What are the health effects?"
    "why is",           # "Why is air quality important?"
    "how does",         # "How does pollution affect health?"
    "explain",          # "Explain the AQI scale"
    "tell me about",    # "Tell me about air pollution"
    "definition",       # "Definition of PM10"
]

BYPASS_CACHE_IF_CONTAINS = [
    "nairobi", "kampala", "lagos",  # City names
    "current", "now", "today",      # Time-sensitive
    "latest", "real-time",          # Real-time data
    "forecast", "tomorrow",         # Future data
]
```

### **Cache Key Generation:**

```python
import hashlib

def generate_cache_key(message: str, history: list) -> str:
    """
    Create unique cache key from message + history
    """
    # Normalize message
    normalized = message.lower().strip()

    # Include last 3 messages for context
    recent_history = history[-3:] if len(history) > 3 else history

    # Serialize
    context = f"{normalized}|{json.dumps(recent_history)}"

    # Hash
    return hashlib.md5(context.encode()).hexdigest()

# Example:
# Input: "What is PM2.5?" + []
# Key: "a1b2c3d4e5f6..." (32 chars)
```

---

## ğŸ“Š Data Formatting Pipeline

```
External API Response
â”‚
â”œâ”€â–º {"pm25": 12.66667, "pm10": 23.12345, "aqi": 45}
â”‚
â–¼
data_formatter.py
â”‚
â”œâ”€â–º format_number(12.66667, decimal_places=1)
â”‚   â””â”€â–º 12.7
â”‚
â”œâ”€â–º format_number(23.12345, decimal_places=1)
â”‚   â””â”€â–º 23.1
â”‚
â”œâ”€â–º format_number(45, decimal_places=1)
â”‚   â””â”€â–º 45.0
â”‚
â–¼
Formatted Response
â”‚
â”œâ”€â–º {
â”‚     "pm25": 12.7,
â”‚     "pm10": 23.1,
â”‚     "aqi": 45.0,
â”‚     "_formatted": true,
â”‚     "_source": "waqi",
â”‚     "_accuracy_note": "Values formatted to 1 decimal place"
â”‚   }
â”‚
â–¼
Returned to AI for synthesis
â”‚
â–¼
User sees: "PM2.5: 12.7 Âµg/mÂ³"
```

---

## ğŸ” Security Layers

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  1. Rate Limiting (20 req/60s per IP)  â”‚
â”‚     â€¢ Prevents abuse                    â”‚
â”‚     â€¢ Configurable per environment      â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                 â”‚
                 â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  2. Input Validation (Pydantic)         â”‚
â”‚     â€¢ Type checking                     â”‚
â”‚     â€¢ Required fields                   â”‚
â”‚     â€¢ Max length limits                 â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                 â”‚
                 â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  3. API Key Protection                  â”‚
â”‚     â€¢ Environment variables only        â”‚
â”‚     â€¢ Never in code                     â”‚
â”‚     â€¢ .env in .gitignore                â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                 â”‚
                 â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  4. CORS Configuration                  â”‚
â”‚     â€¢ Whitelist allowed origins         â”‚
â”‚     â€¢ Proper headers                    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## ğŸ’° Cost Breakdown (100K Users/Month)

### **WITHOUT Optimizations:**

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Component               â”‚ Calls   â”‚ Cost     â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ AI API (Gemini)         â”‚ 500K    â”‚ $2,000   â”‚
â”‚ WAQI API                â”‚ 300K    â”‚ $300     â”‚
â”‚ AirQo API (free)        â”‚ 100K    â”‚ $0       â”‚
â”‚ Database writes         â”‚ 1M      â”‚ $400     â”‚
â”‚ Server compute          â”‚ 730h    â”‚ $500     â”‚
â”‚ Redis cache             â”‚ 730h    â”‚ $100     â”‚
â”‚ Storage                 â”‚ 100GB   â”‚ $400     â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ TOTAL                   â”‚         â”‚ $3,700   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### **WITH Optimizations:**

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Component               â”‚ Calls   â”‚ Cost     â”‚ Savings   â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ AI API (65% cached)     â”‚ 175K    â”‚ $700     â”‚ -65% â¬‡ï¸   â”‚
â”‚ WAQI API (cached)       â”‚ 100K    â”‚ $100     â”‚ -67% â¬‡ï¸   â”‚
â”‚ AirQo API (free)        â”‚ 50K     â”‚ $0       â”‚ -50% â¬‡ï¸   â”‚
â”‚ Database writes         â”‚ 100K    â”‚ $40      â”‚ -90% â¬‡ï¸   â”‚
â”‚ Server compute          â”‚ 730h    â”‚ $500     â”‚ 0%        â”‚
â”‚ Redis cache             â”‚ 730h    â”‚ $180     â”‚ +80% â¬†ï¸   â”‚
â”‚ Storage                 â”‚ 10GB    â”‚ $100     â”‚ -75% â¬‡ï¸   â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ TOTAL                   â”‚         â”‚ $1,820   â”‚ -51% ğŸ‰   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## ğŸš€ Scalability Model

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Users/Month      â”‚ Req/Sec  â”‚ Instances  â”‚ Cost/Month  â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ 10K              â”‚ 5        â”‚ 1          â”‚ $420        â”‚
â”‚ 100K             â”‚ 50       â”‚ 2          â”‚ $1,820      â”‚
â”‚ 500K             â”‚ 250      â”‚ 5          â”‚ $8,510      â”‚
â”‚ 1M               â”‚ 500      â”‚ 10         â”‚ $17,020     â”‚
â”‚ 5M               â”‚ 2,500    â”‚ 50         â”‚ $85,100     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

Each instance:
â€¢ 2 vCPU, 4GB RAM
â€¢ Handles ~50 req/sec
â€¢ Horizontal scaling (stateless)
â€¢ Load balancer distributes traffic
```

---

## ğŸ“ˆ Performance Metrics

### **Response Times:**

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Request Type           â”‚ Before     â”‚ After       â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ Cached educational     â”‚ 3-5s       â”‚ 50-100ms    â”‚
â”‚ Uncached AI            â”‚ 3-5s       â”‚ 2-4s        â”‚
â”‚ With WAQI tool         â”‚ 5-8s       â”‚ 3-6s        â”‚
â”‚ With multiple tools    â”‚ 8-12s      â”‚ 5-9s        â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### **Throughput:**

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Configuration          â”‚ Req/Sec    â”‚ Concurrent  â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ Single instance        â”‚ 50         â”‚ 100         â”‚
â”‚ With Redis caching     â”‚ 500        â”‚ 1,000       â”‚
â”‚ 5 instances (LB)       â”‚ 2,500      â”‚ 5,000       â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## ğŸ¯ Success Criteria

After implementation, verify:

- âœ… **Cache hit rate: 60-80%** for educational queries
- âœ… **Database writes: <10%** of total requests
- âœ… **Response time: <100ms** for cached queries
- âœ… **Rate limit: 429 errors** for excessive requests
- âœ… **Data accuracy: 1 decimal** on all numeric values
- âœ… **Token tracking: Present** in all responses
- âœ… **Context retention: Works** with client-side history

---

**Architecture Version:** 2.0 (Optimized)  
**Last Updated:** December 30, 2025
